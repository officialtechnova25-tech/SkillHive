<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skill Hive - Find Skills</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
  
  <link href="css/styles.css" rel="stylesheet" /> 

  <style>
     :root {
      --header-footer-bg: rgba(255, 255, 255, 0.5);
      --card-bg: rgba(255, 255, 255, 0.4);
      --border-color: rgba(0, 0, 0, 0.1);
      --card-shadow: 0 8px 32px rgba(31,38,135,0.1);
      --text-color: var(--bs-dark);
    }
    [data-bs-theme="dark"] {
      --header-footer-bg: rgba(10,10,20,0.7);
      --card-bg: rgba(25,28,42,0.7);
      --border-color: rgba(255,255,255,0.15);
      --card-shadow: 0 8px 32px rgba(0,0,0,0.2);
      --text-color: var(--bs-light);
    }
    body {
      font-family: "Montserrat", sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: var(--text-color);
      transition: background-color 0.4s ease;
    }
    body[data-bs-theme="light"] {
      background-color: #f0f2ff;
    }
    body[data-bs-theme="dark"] {
      background-color: #0b0c10;
    }
    main { flex: 1; }
    #tsparticles { position: fixed; width: 100%; height: 100%; z-index: -1; top: 0; left: 0; }
    .glass-effect {
      background: var(--card-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--border-color);
      box-shadow: var(--card-shadow);
      transition: background 0.4s ease, border-color 0.4s ease;
    }
    .glass-header, .glass-footer {
      background: var(--header-footer-bg);
      backdrop-filter: blur(15px);
      border-color: var(--border-color);
      transition: background 0.4s ease, border-color 0.4s ease;
    }
    .navbar-brand span { font-family: 'Orbitron', sans-serif; }
    .filter-btn.active {
      background-color: var(--bs-primary);
      color: #fff;
      box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.5);
    }
    .tutor-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .tutor-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 32px rgba(0,0,0,0.2);
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--bs-primary);
    }
    .skill-tag {
      padding: 4px 10px;
      margin: 2px;
      font-size: 0.8rem;
      background: rgba(var(--bs-primary-rgb), 0.1);
      border: 1px solid rgba(var(--bs-primary-rgb), 0.3);
      color: var(--bs-primary);
      border-radius: 20px;
      font-weight: 500;
    }
    .animate-on-scroll {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .animate-on-scroll.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    /* === MENU STYLES === */
    .offcanvas {
      background: var(--header-footer-bg);
      backdrop-filter: blur(15px);
      color: var(--text-color);
      border-right: 1px solid var(--border-color);
      transition: background 0.4s ease, border-color 0.4s ease, color 0.4s ease, transform 0.3s ease-in-out;
    }
    .offcanvas-header {
      border-bottom: 1px solid var(--border-color);
    }
    .offcanvas-body .nav-links { padding-left: 0; list-style-type: none; }
    .offcanvas-body .nav-links a {
      color: var(--text-color);
      text-decoration: none;
      padding: 10px 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: 0.3s;
      font-weight: 500;
    }
    .offcanvas-body .nav-links a:hover {
      background: rgba(var(--bs-primary-rgb), 0.1);
      color: var(--bs-primary);
      transform: translateX(5px);
    }
    .offcanvas-body .nav-links a.active {
      background: var(--bs-primary);
      color: white; 
    }
    [data-bs-theme="dark"] .offcanvas-body .nav-links a {
      color: var(--bs-light);
    }
    [data-bs-theme="dark"] .offcanvas-body .nav-links a.active {
      color: white;
    }
    
    /* === NEW: Link style for tutor name === */
    a.tutor-name-link {
        text-decoration: none;
        color: inherit;
    }
    a.tutor-name-link:hover h5 {
        color: var(--bs-primary);
    }
  </style>
</head>

<body data-bs-theme="light">
  <div id="tsparticles"></div>

  <header class="sticky-top glass-header">
    <div class="container d-flex justify-content-between align-items-center py-2">
      <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvas"><i data-lucide="menu"></i></button>
      <a class="navbar-brand d-inline-flex align-items-center mx-auto" href="index.html"> <img src="assets/images/skillhive-logo.png" alt="Skill Hive Logo" width="110" height="70" /> <span class="ms-2 fs-4">Skill Hive</span>
      </a>
      <div class="d-flex align-items-center">
        <div id="auth-links"></div>
        <button id="darkModeToggle" class="btn btn-outline-secondary ms-2" title="Toggle theme"><i id="themeIcon" data-lucide="moon"></i></button>
      </div>
    </div>
  </header>

  <main class="container my-5">
    <h1 class="text-center mb-4 fw-bold">Find a Skill or Tutor</h1>
    <div class="row justify-content-center mb-4">
      <div class="col-lg-8">
        <div class="glass-effect p-2 rounded-4 mb-3">
          <div class="input-group">
            <input id="searchInput" class="form-control form-control-lg border-0 bg-transparent" placeholder="Search for tutors (e.g., Emma) or skills (e.g., Python)..." />
            <button id="searchButton" class="btn btn-primary px-4"><i data-lucide="search" class="me-1"></i>Search</button>
          </div>
        </div>
      </div>
      <div class="col-lg-8 d-flex justify-content-center align-items-center gap-3 flex-wrap mt-3">
        <div class="d-flex align-items-center gap-2">
          <strong class="me-1">Level:</strong>
          <button class="btn btn-outline-secondary btn-sm filter-btn" data-level="Beginner">Beginner</button>
          <button class="btn btn-outline-secondary btn-sm filter-btn" data-level="Intermediate">Intermediate</button>
          <button class="btn btn-outline-secondary btn-sm filter-btn" data-level="Expert">Expert</button>
        </div>

        <div class="d-flex align-items-center gap-2">
          <label for="languageFilter" class="form-label mb-0"><strong>Language:</strong></label>
          <select id="languageFilter" class="form-select form-select-sm" style="width: 150px;">
            <option value="">All</option>
            <option value="English">English</option>
            <option value="Spanish">Spanish</option>
            <option value="French">French</option>
            <option value="German">German</option>
            <option value="Hindi">Hindi</option>
            <option value="Malayalam">Malayalam</option>
            </select>
        </div>
      </div>
      </div>

    <div id="tutor-grid" class="row g-4">
      <div class="col-12 text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading tutors...</span>
        </div>
      </div>
    </div>
    <div id="no-results" class="text-center d-none mt-5">
      <div class="glass-effect p-4 rounded-4"><h4>No tutors found matching your search.</h4></div>
    </div>
  </main>

  <footer class="py-4 glass-footer mt-auto">
    <div class="container text-center">
      <p class="mb-0 text-muted">&copy; 2025 Skill Hive â€” Powered by Tech Nova</p>
    </div>
  </footer>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mainOffcanvasLabel">Skill Hive Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <ul class="list-unstyled nav-links">
        <li class="text-muted small mb-2 text-start">MAIN MENU</li>
        <li><a href="index.html"><i data-lucide="home"></i> Home</a></li>
        <li><a href="dashboard.html"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
        <li><a href="profile.html"><i data-lucide="user"></i> My Profile</a></li>
        <li><a href="search.html" class="active"><i data-lucide="search"></i> Find Skills</a></li>
      </ul>
      <hr />
      <ul class="list-unstyled nav-links">
         <li class="text-muted small mb-2 text-start">SETTINGS</li>
         <li><a href="notifications.html"><i data-lucide="bell"></i> Notifications</a></li>
         <li><a href="settings.html"><i data-lucide="settings"></i> Account Settings</a></li>
         <li><a href="help.html"><i data-lucide="help-circle"></i> Help & Support</a></li>
         <li id="adminPanelLink" style="display:none;"><a href="admin.html"><i data-lucide="shield"></i> Admin Panel</a></li>
      </ul>
      <div id="offcanvas-auth-links" class="mt-auto">
        </div>
    </div>
  </div>

  <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1055; margin-top: 20px;">
    <div id="mainToast" class="toast align-items-center text-white bg-success border-0 text-center shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex justify-content-center">
        <div class="toast-body" id="toastMessage"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    lucide.createIcons();

    // --- DOM Elements ---
    const tutorGrid = document.getElementById("tutor-grid");
    const noResults = document.getElementById("no-results");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const filterBtns = document.querySelectorAll(".filter-btn");
    const languageFilter = document.getElementById("languageFilter");
    const authLinks = document.getElementById("auth-links");
    const offcanvasAuthLinks = document.getElementById("offcanvas-auth-links");

    let selectedLevel = null;
    let tutors = []; // Holds the master list of tutors fetched initially

    // --- Authentication & Helpers ---
    const token = localStorage.getItem("token");
    const userString = localStorage.getItem("user");
    let currentUser = null; 
    try {
        currentUser = userString ? JSON.parse(userString) : null;
    } catch(e) { console.error("Error parsing user from localStorage:", e); }

    const getAuthHeaders = (isJson = true) => {
        const headers = {};
        if (isJson) headers["Content-Type"] = "application/json";
        if (token) headers["Authorization"] = `Bearer ${token}`;
        return headers;
    };

    const logout = () => { localStorage.clear(); window.location.href = "login.html"; };

    // --- Toast Notification Function ---
    function showToast(message, type = "success") {
      const toastEl = document.getElementById("mainToast");
      const toastMsg = document.getElementById("toastMessage");
      if (!toastEl || !toastMsg) return;
      
      toastEl.classList.remove("bg-success", "bg-danger", "bg-warning");
      toastEl.classList.add(
        type === "error" ? "bg-danger" : type === "warning" ? "bg-warning" : "bg-success"
      );
      toastMsg.textContent = message;
      const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
      toast.show();
    }

    // --- Authentication UI ---
    if (token && currentUser) {
        authLinks.innerHTML = `<span class="navbar-text me-3 d-none d-lg-inline">Hi, ${currentUser.name}!</span><a href="dashboard.html" class="btn btn-sm btn-outline-primary me-2">Dashboard</a><button id="logoutBtnHeader" class="btn btn-sm btn-outline-danger">Logout</button>`;
        offcanvasAuthLinks.innerHTML = `<hr/><button id="logoutBtnCanvas" class="btn btn-outline-danger w-100"><i data-lucide="log-out" class="me-1"></i>Logout</button>`;
        document.getElementById("logoutBtnHeader")?.addEventListener("click", logout);
        document.getElementById("logoutBtnCanvas")?.addEventListener("click", logout);
        if (currentUser.role === 'admin') {
            const adminLink = document.getElementById('adminPanelLink');
            if (adminLink) adminLink.style.display = 'block';
        }
    } else {
        // Logged out users can still search
        authLinks.innerHTML = `<a href="login.html" class="btn btn-sm btn-light me-2">Login</a><a href="signup.html" class="btn btn-sm btn-primary">Sign Up</a>`;
        offcanvasAuthLinks.innerHTML = `<hr/><div class="d-grid gap-2"><a href="login.html" class="btn btn-light">Login</a><a href="signup.html" class="btn btn-primary">Sign Up</a></div>`;
    }
    lucide.createIcons(); // Re-render icons after adding auth buttons


    // --- API Fetch Tutors ---
    const fetchTutors = async () => {
      tutorGrid.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading tutors...</span></div></div>`; 
      try {
        const res = await fetch(`/api/users/search`, {
            headers: getAuthHeaders(false) // Pass auth token
        }); 
        if (!res.ok) {
            let errorMsg = `Failed to fetch tutors: ${res.status}`;
            try {
                const errorData = await res.json();
                errorMsg = errorData.message || errorMsg;
            } catch (_) { errorMsg = res.statusText; }
            throw new Error(errorMsg);
        }
        const data = await res.json();
        return data.filter(u => u && ["teach", "both"].includes(u.userType) && Array.isArray(u.skills));
      } catch (err) {
        console.error("Error fetching tutors:", err);
        tutorGrid.innerHTML = `<div class="col-12"><p class="text-danger text-center">Error loading tutors: ${err.message}</p></div>`;
        noResults.classList.add('d-none');
        return [];
      }
    };

    // --- Render Tutors ---
    const renderTutors = (list) => {
      tutorGrid.innerHTML = "";
      noResults.classList.toggle("d-none", list.length > 0);

      if (!Array.isArray(list)) {
          console.error("renderTutors received non-array:", list);
          noResults.classList.remove('d-none');
          return;
      }

      list.forEach((tutorUser) => {
        const skillsHtml = Array.isArray(tutorUser.skills) ? tutorUser.skills
          .map(s => `<span class="skill-tag">${escapeHtml(s.name || s)}</span>`)
          .join('') : '';

        const card = document.createElement("div");
        card.className = "col-lg-4 col-md-6 animate-on-scroll";
        const tutorName = tutorUser.name || 'Unnamed Tutor';
        
        const profilePicUrl = (tutorUser.profilePic && typeof tutorUser.profilePic === 'string') 
                              ? tutorUser.profilePic 
                              : '/uploads/profile-pics/default.png'; 

        card.innerHTML = `
          <div class="card glass-effect tutor-card h-100 p-3 rounded-4">
            <div class="d-flex align-items-center mb-3">
              <img src="${escapeHtml(profilePicUrl)}" class="avatar me-3" alt="${escapeHtml(tutorName)}" loading="lazy">
              <div>
                <a href="tutor-profile.html?id=${tutorUser._id}" class="tutor-name-link">
                  <h5 class="mb-0">${escapeHtml(tutorName)}</h5>
                </a>
              </div>
            </div>
            <p class="mb-1 fw-bold small">Skills Taught:</p>
            <div class="d-flex flex-wrap mb-3" style="min-height: 50px;">
              ${skillsHtml || '<span class="text-muted small">No skills listed.</span>'}
            </div>
            
            <div class="d-grid gap-2 d-sm-flex justify-content-start mt-auto">
                <button class="btn btn-primary request-session-btn" data-tutor-id="${tutorUser._id}">
                    <i data-lucide="calendar-plus" class="me-1" style="width:16px;"></i> Request Session
                </button>
                <button class="btn btn-success start-now-btn" data-tutor-id="${tutorUser._id}">
                    <i data-lucide="video" class="me-1" style="width:16px;"></i> Start Now
                </button>
            </div>
            </div>`;
        tutorGrid.appendChild(card);
      });
      attachRequestButtonListeners(); // Attach listeners after rendering
      animateOnScroll();
      lucide.createIcons(); // Render icons on new buttons
    };

    // --- Filter Logic ---
    const filterTutors = () => {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedLang = languageFilter.value;

      console.log(`Filtering with: Term='${searchTerm}', Lang='${selectedLang}', Level='${selectedLevel}'`);

      const filtered = tutors.filter(t => {
        if (!t) return false;
        const nameMatch = t.name?.toLowerCase().includes(searchTerm);
        const skillMatch = Array.isArray(t.skills) && t.skills.some(s => (s.name || s)?.toLowerCase().includes(searchTerm));
        const nameOrSkillMatch = searchTerm === "" || nameMatch || skillMatch;
        const levelMatch = !selectedLevel || (Array.isArray(t.skills) && t.skills.some(s => s.level === selectedLevel)); // Assuming level exists on skill object
        const languageMatch = !selectedLang || (t.language && t.language.toLowerCase() === selectedLang.toLowerCase());
        return nameOrSkillMatch && levelMatch && languageMatch;
      });
      console.log("Filtered list:", filtered);
      renderTutors(filtered);
    };

    // --- Search Animation ---
    const triggerSearchAnimation = () => {
       if (typeof tsParticles === 'undefined' || !tsParticles.dom || tsParticles.dom.length === 0) return;
       try { /* ... animation logic ... */
          const particles = tsParticles.domItem(0);
          if (!particles || !particles.options) return;
          const normalSpeed = particles.options.particles.move.speed || 1.5;
          const burstSpeed = 15;
          particles.options.particles.move.speed = burstSpeed;
          particles.refresh();
          setTimeout(() => {
            const currentParticles = tsParticles.domItem(0);
            if (currentParticles && currentParticles.options) {
                currentParticles.options.particles.move.speed = normalSpeed;
                currentParticles.refresh();
            }
          }, 700);
       } catch(e) { console.error("Error triggering search animation:", e); }
    };

    // --- Scroll Animation ---
    const animateOnScroll = () => {
         const observer = new IntersectionObserver((entries, observerRef) => {
            entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
                observerRef.unobserve(entry.target);
            }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll(".animate-on-scroll").forEach(el => observer.observe(el));
    };


    // --- Theme & Particles (FIXED to be consistent) ---
    const darkModeToggle = document.getElementById("darkModeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const body = document.body;

    const loadParticles = () => { 
      if (typeof tsParticles === 'undefined') return; 
      try { 
        if (window.tsParticles?.dom?.length) window.tsParticles.dom.forEach(d => d.destroy()); 
        const color = getComputedStyle(document.body).getPropertyValue('--bs-primary').trim() || "#0d6efd"; 
        tsParticles.load("tsparticles", { 
          fpsLimit: 60, 
          particles: { 
            number: { value: 40 }, 
            color: { value: color }, 
            opacity: { value: { min: 0.1, max: 0.3 } }, 
            size: { value: { min: 8, max: 18 } }, 
            move: { enable: true, speed: 1.0 } 
          } 
        }); 
      } catch (e) { console.error("tsParticles error", e); } 
    };

    function setTheme(theme) { 
      const isDark = theme === "dark"; 
      body.setAttribute("data-bs-theme", theme); 
      if (themeIcon) themeIcon.setAttribute("data-lucide", isDark ? "sun" : "moon"); 
      try { lucide.createIcons(); } catch (e) { console.warn("Lucide error:", e); } 
      localStorage.setItem("theme", theme); // Consistent key
      setTimeout(loadParticles, 50); 
    }

    try { 
      const savedTheme = localStorage.getItem("theme"); // Consistent key
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches; 
      setTheme(savedTheme ? savedTheme : (prefersDark ? "dark" : "light")); 
      
      if (darkModeToggle) { 
        darkModeToggle.addEventListener("click", () => { 
          const newTheme = body.getAttribute("data-bs-theme") === "dark" ? "light" : "dark"; 
          setTheme(newTheme); 
        }); 
      } 
    } catch (err) { console.error("Theme init error", err); }
    // --- End Theme Fix ---

    // --- Utility: Escape HTML ---
    function escapeHtml(str) {
        if (!str && str !== 0) return "";
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return String(str).replace(/[&<>"']/g, m => map[m]);
    }
    
    // --- NEW: Start Now Session Logic ---
    const handleStartNow = async (event) => {
        if (!token || !currentUser) {
            showToast("Please log in to start a session.", "warning");
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
        }
        
        const button = event.target.closest('.start-now-btn');
        if (!button) return; 

        const tutorId = button.dataset.tutorId;
        if (!tutorId) {
            showToast("Could not start session: Tutor ID missing.", "error");
            return;
        }

        if (!confirm(`Start an instant session with this tutor? They will be notified.`)) {
            return;
        }

        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting...';

        try {
            // This is the new API route we created in sessionRoutes.js
            const response = await fetch('/api/sessions/start-now', { 
                method: 'POST',
                headers: getAuthHeaders(true),
                body: JSON.stringify({ tutorId: tutorId })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.message || `Request failed`);
            
            // This session is NOT confirmed yet. The tutor must accept.
            // We just let the user know the request was sent.
            showToast("Instant session request sent! Please wait for the tutor to accept.", "success");
            button.innerHTML = 'Request Sent';
            button.disabled = true;

        } catch (error) {
            console.error("Error starting session:", error);
            showToast(`Error: ${error.message}`, "error");
            button.disabled = false; // Re-enable on error
            button.innerHTML = 'Start Now';
        }
    };

    // --- Session Request Logic ---
    const handleRequestSession = async (event) => {
        if (!token || !currentUser) {
            showToast("Please log in to request a session.", "warning");
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
        }

        const button = event.target.closest('.request-session-btn');
        if (!button) return; 

        const tutorId = button.dataset.tutorId;
        if (!tutorId) {
            showToast("Could not request session: Tutor ID missing.", "error");
            return;
        }

        if (!confirm(`Request a session with this tutor?`)) {
            return;
        }

        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

        try {
            const response = await fetch('/api/sessions/request', {
                method: 'POST',
                headers: getAuthHeaders(true),
                body: JSON.stringify({ tutorId: tutorId })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `Request failed: ${response.statusText}`);
            }

            showToast("Session request sent successfully!", "success");
            button.innerHTML = 'Request Sent'; // Keep disabled

        } catch (error) {
            console.error("Error requesting session:", error);
            showToast(`Error sending request: ${error.message}`, "error");
            button.disabled = false; // Re-enable on error
            button.innerHTML = 'Request Session';
        }
    };

    // Attach listeners to request buttons (will be called after rendering)
    const attachRequestButtonListeners = () => {
        tutorGrid.removeEventListener('click', handleRequestSessionEventDelegation); // Remove old listener first
        tutorGrid.addEventListener('click', handleRequestSessionEventDelegation);
    };

    // Event delegation handler
    function handleRequestSessionEventDelegation(event) {
        const requestButton = event.target.closest('.request-session-btn');
        if (requestButton) {
            handleRequestSession({ target: requestButton });
            return;
        }
        
        const startNowButton = event.target.closest('.start-now-btn');
        if (startNowButton) {
            handleStartNow({ target: startNowButton });
            return;
        }
    }
    
    // --- Auto-highlight active menu link (REMOVED) ---
    
    // --- Event Listeners (Main Search/Filter) ---
    searchButton.addEventListener("click", () => {
      triggerSearchAnimation();
      filterTutors();
    });
    searchInput.addEventListener("keyup", (e) => {
      filterTutors(); // Filter as user types
      if (e.key === "Enter") triggerSearchAnimation();
    });
    filterBtns.forEach(btn => btn.addEventListener("click", () => {
       if (selectedLevel === btn.dataset.level) {
        selectedLevel = null; btn.classList.remove("active");
       } else {
        filterBtns.forEach(b => b.classList.remove("active"));
        selectedLevel = btn.dataset.level; btn.classList.add("active");
       }
       filterTutors();
    }));
    languageFilter.addEventListener("change", filterTutors);


    // --- Initial Load ---
    async function initialLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const queryFromUrl = urlParams.get('query');
        let performInitialFilter = false;

        if (queryFromUrl) {
            searchInput.value = queryFromUrl;
            performInitialFilter = true;
        }

        // Must be logged in to search
        if (!token || !currentUser) {
            tutorGrid.innerHTML = `<div class="col-12 text-center p-5"><div class="glass-effect p-4 rounded-4"><h4>Please <a href="login.html">log in</a> to search for tutors.</h4></div></div>`; 
            noResults.classList.add('d-none');
            return;
        }

        tutors = await fetchTutors(); // Fetch all tutors first
        console.log("Initial tutor list loaded:", tutors.length, "tutors");

        // Render initially (either all or filtered based on URL query)
        if (performInitialFilter) {
            filterTutors(); // Filter based on URL query
            triggerSearchAnimation();
        } else {
             renderTutors(tutors); // Render all
        }
        
        // --- Call to highlight function REMOVED ---
    }

    initialLoad(); // Run the initial load sequence

  });
  </script>
</body>
</html>