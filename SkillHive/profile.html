<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile - Skill Hive</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet" />

  <style>
    /* --- keep your same styles --- */
  </style>
</head>

<body data-bs-theme="light" class="dashboard-page">
  <div id="tsparticles"></div>

  <!-- Header, main content, modal, offcanvas etc... remain the same -->
  <!-- (unchanged HTML structure from your version) -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

  <script>
  let SKILL_OPTIONS = [];

  document.addEventListener("DOMContentLoaded", () => {
    // âœ… Auto-switch API base
    const API_BASE_URL =
      window.location.hostname === "localhost"
        ? "http://localhost:5000"
        : "https://skillhive-backend-qdss.onrender.com";

    const token = localStorage.getItem("token") || "";
    const fileInput = document.getElementById("fileInput");
    const profilePicEl = document.getElementById("profilePic");
    const profileNameEl = document.getElementById("profile-name");
    const profileEmailEl = document.getElementById("profile-email");
    const profileUserTypeEl = document.getElementById("profile-userType");
    const profileGenderEl = document.getElementById("profile-gender");
    const profileLocationEl = document.getElementById("profile-location");
    const profileLanguageEl = document.getElementById("profile-language");
    const profileAboutEl = document.getElementById("profile-about");
    const profileJoinedEl = document.getElementById("profile-joined");
    const skillsSection = document.getElementById("skillsOfferingSection");
    const skillsEl = document.getElementById("skillsOfferingList");
    const skillsHeading = document.getElementById("skills-heading");
    const interestsEl = document.getElementById("learningInterestsList");
    const editBtn = document.getElementById("openEditBtn");
    const editModalEl = document.getElementById("editProfileModal");
    const editForm = document.getElementById("editProfileForm");
    const editName = document.getElementById("editName");
    const editEmail = document.getElementById("editEmail");
    const editGender = document.getElementById("editGender");
    const editLocation = document.getElementById("editLocation");
    const editLanguage = document.getElementById("editLanguage");
    const $editLearningInterestsInput = $('#editLearningInterestsInput');
    const $editSkillInput = $('#editSkillInput'); 
    const editAbout = document.getElementById("editAbout");
    const userTypeRadios = document.getElementById("userTypeRadios");
    const adminPanelLink = document.getElementById("adminPanelLink");
    const authSection = document.getElementById("auth-section");
    const offcanvasAuthLinks = document.getElementById("offcanvas-auth-links");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const themeIcon = document.getElementById("themeIcon");

    const certificatesSection = document.getElementById("certificatesSection");
    const certificateList = document.getElementById("certificateList");
    const certificateUploadForm = document.getElementById("certificateUploadForm");
    const $certificateNameInput = $('#certificateName');
    const certificateFile = document.getElementById("certificateFile");
    const uploadSpinner = document.getElementById("uploadSpinner");

    const skillsWrapper = document.getElementById("skillsInputWrapper");
    const interestsWrapper = document.getElementById("interestsInputWrapper");

    let currentUser = null;
    let notificationToast = null;

    const getAuthHeaders = (json = true) => {
      const headers = {};
      if (json) headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = `Bearer ${token}`;
      return headers;
    };

    /* ---------------- FETCHES UPDATED TO USE API_BASE_URL ---------------- */

    async function fetchSkillOptions() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/skills`, { headers: getAuthHeaders(false) });
        if (!res.ok) throw new Error(`Could not load skills list: ${res.statusText}`);
        const skills = await res.json();
        SKILL_OPTIONS = Array.isArray(skills) ? skills.map(s => s.name).filter(Boolean).sort() : [];
      } catch {
        SKILL_OPTIONS = ["Web Development", "Python", "Data Science"];
      }
    }

    async function fetchCurrentUser() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/auth/me`, { headers: getAuthHeaders() });
        if (!res.ok) throw new Error("Not authenticated");
        currentUser = await res.json();
        populateUI();
      } catch {
        localStorage.clear();
        window.location.href = "login.html";
      }
    }

    async function uploadCroppedImage(formData) {
      if (!currentUser?._id) return;
      const res = await fetch(`${API_BASE_URL}/api/users/upload/${currentUser._id}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });
      if (!res.ok) throw new Error("Image upload failed");
      const data = await res.json();
      profilePicEl.src = data.user.profilePic;
    }

    if (editForm) {
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const selectedType = document.querySelector("#userTypeRadios input[name='userType']:checked")?.value || "study";
        const payload = {
          name: editName.value.trim(),
          gender: editGender.value,
          location: editLocation.value.trim(),
          language: editLanguage.value,
          about: editAbout.value.trim(),
          userType: selectedType,
          skills: ($editSkillInput.val() || []).map(n => ({ name: n })),
          learningInterests: ($editLearningInterestsInput.val() || []).map(n => ({ name: n })),
        };
        const res = await fetch(`${API_BASE_URL}/api/users/${currentUser._id}`, {
          method: "PUT",
          headers: getAuthHeaders(true),
          body: JSON.stringify(payload),
        });
        const updated = await res.json();
        currentUser = updated;
        populateUI();
      });
    }

    if (certificateUploadForm) {
      certificateUploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const certName = $certificateNameInput.val();
        const certFile = certificateFile.files[0];
        if (!certName || !certFile) return alert("Please select a certificate name and file.");
        const formData = new FormData();
        formData.append("certificateName", certName);
        formData.append("certificateFile", certFile);
        const res = await fetch(`${API_BASE_URL}/api/users/upload-certificate`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });
        const result = await res.json();
        currentUser = result.user;
      });
    }

    function populateUI() {
      if (!currentUser) return;
      profileNameEl.textContent = currentUser.name;
      profileEmailEl.textContent = currentUser.email;
      profilePicEl.src = currentUser.profilePic || "/uploads/profile-pics/default.png";
    }

    async function main() {
      await fetchSkillOptions();
      await fetchCurrentUser();
    }

    main();
  });
  </script>
</body>
</html>
