<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Profile - Skill Hive</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
  
  <link href="css/styles.css" rel="stylesheet" />

  <style>
    /* Using the same layout styles from your profile.html */
    .profile-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        max-width: 1100px;
        margin: auto;
        border-radius: 14px;
        overflow: hidden;
        background-color: var(--bs-body-bg);
        box-shadow: var(--bs-box-shadow-sm);
    }
    .profile-left-col {
        flex: 0 0 300px;
        background-color: var(--bs-card-bg);
        padding: 20px;
        border-right: 1px solid var(--bs-border-color);
        text-align: center;
        border-radius: 14px 0 0 14px;
    }
    .profile-right-col {
        flex: 1;
        min-width: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        border-radius: 0 14px 14px 0;
    }
    @media (max-width: 900px) {
        .profile-container { flex-direction: column; border-radius: 14px; }
        .profile-left-col { flex: auto; width: 100%; border-right: none; border-bottom: 1px solid var(--bs-border-color); border-radius: 14px 14px 0 0; }
        .profile-right-col { flex: auto; width: 100%; border-radius: 0 0 14px 14px; }
    }
    .avatar { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bs-primary); box-shadow: 0 10px 30px rgba(var(--bs-primary-rgb), 0.12); display:block; margin: 0 auto 12px; }
    [data-bs-theme="dark"] .avatar { border-color: var(--bs-primary); box-shadow: 0 10px 30px rgba(var(--bs-primary-rgb), 0.15); }
    .skill-list-container {
      background-color: var(--bs-body-bg);
      border-radius: 8px;
      padding: 0;
      border: 1px solid var(--bs-border-color);
    }
    .skill-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      color: var(--bs-body-color);
      border-bottom: 1px solid var(--bs-border-color-translucent);
    }
    .skill-list-item:last-child { border-bottom: none; }
    .skill-list-item span { font-weight: 500; }
    .skill-list-container .text-muted.empty-message {
      color: var(--bs-secondary-color) !important;
      padding: 1rem;
      text-align: center;
      display: block;
    }
    .cert-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }
    .cert-link {
        text-decoration: none;
        font-weight: 500;
        color: var(--bs-body-color);
    }
    .cert-link:hover {
        color: var(--bs-primary);
    }
    /* Header/Menu styles */
    .offcanvas-body .nav-links li a { font-size: 1.1rem; padding: 14px 16px; gap: 12px; display: flex; align-items: center; }
    .offcanvas-body .nav-links li a i { width: 22px; height: 22px; stroke-width: 2.5; }
    .glass-header .btn[data-bs-target="#mainOffcanvas"], .glass-header #darkModeToggle { padding: 0.5rem 0.8rem; line-height: 1; }
    .glass-header .btn[data-bs-target="#mainOffcanvas"] i, .glass-header #darkModeToggle i { width: 28px; height: 28px; stroke-width: 2.5; }
  </style>
</head>

<body data-bs-theme="light" class="dashboard-page">
  <div id="tsparticles"></div>

  <header class="sticky-top glass-effect glass-header py-2">
    <div class="container d-flex align-items-center">
      <button class="btn btn-primary me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvas"> <i data-lucide="menu"></i> </button>
      <a class="navbar-brand mx-auto d-flex align-items-center" href="index.html" style="gap:.5rem"> <img src="assets/images/skillhive-logo.png" alt="Skill Hive" height="48" /> <span style="font-family:'Orbitron',sans-serif;font-weight:700;">Skill Hive</span> </a>
      <div class="d-flex align-items-center"> <div id="auth-section"></div> <button id="darkModeToggle" class="btn btn-outline-secondary ms-2" title="Toggle theme"> <i id="themeIcon" data-lucide="moon"></i> </button> </div>
    </div>
  </header>

  <main class="container my-5">
    <div id="loading" class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    
    <div id="profileContent" class="glass-effect profile-container d-none">
      
      <div class="profile-left-col">
        <img id="profilePic" class="avatar" src="/uploads/profile-pics/default.png" alt="Profile" />
        <h3 id="profile-name" class="mt-2 mb-0">—</h3>
        <p id="profile-email" class="text-muted mb-2">—</p>
        <p><span id="profile-userType" class="badge rounded-pill px-3 py-1">—</span></p>
      </div>

      <div class="profile-right-col">
          <div class="card card-body glass-effect p-3">
              <h5 class="mb-3">Personal Details</h5>
              <p class="mb-2 d-flex justify-content-between"><strong>Gender:</strong> <span id="profile-gender">—</span></p>
              <p class="mb-2 d-flex justify-content-between"><strong>Location:</strong> <span id="profile-location">—</span></p>
              <p class="mb-0 d-flex justify-content-between"><strong>Member Since:</strong> <span id="profile-joined">—</span></p>
          </div>
          
          <div class="card card-body glass-effect p-3">
              <h5 class="mb-3">About</h5>
              <p id="profile-about" class="text-muted mb-0">No description added yet.</p>
          </div>
          
          <div id="skillsOfferingSection" class="card card-body glass-effect p-3">
              <h5 class="mb-3" id="skills-heading">Skills (Teaching)</h5>
              <div id="skillsOfferingList" class="skill-list-container"></div>
          </div>
          
          <div id="interestsSection" class="card card-body glass-effect p-3">
              <h5 class="mb-3">Interests (Learning)</h5>
              <div id="learningInterestsList" class="skill-list-container"></div>
          </div>
          
          <div id="certificatesSection" class="card card-body glass-effect p-3">
              <h5 class="mb-3">Certificates</h5>
              <div id="certificateList" class="list-group list-group-flush"></div>
          </div>
          
      </div> 
    </div> 
  </main>

  <footer class="glass-effect glass-footer text-center py-3 mt-auto"> <p class="mb-0 text-muted">&copy; 2025 Skill Hive — Learn, Teach, Grow.</p> </footer>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
    <div class="offcanvas-header"> <h5 class="offcanvas-title" id="mainOffcanvasLabel">Skill Hive Menu</h5> <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div>
    <div class="offcanvas-body d-flex flex-column">
      <ul class="list-unstyled nav-links">
        <li class="text-muted small mb-2 text-start">MAIN MENU</li>
        <li><a href="index.html"><i data-lucide="home"></i> Home</a></li>
        <li id="dashboard-menu-item"><a href="dashboard.html"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
        <li><a href="profile.html"><i data-lucide="user"></i> My Profile</a></li>
        <li><a href="search.html"><i data-lucide="search"></i> Find Skills</a></li>
      </ul>
      <hr />
      <ul class="list-unstyled nav-links">
        <li class="text-muted small mb-2 text-start">SETTINGS</li>
        <li><a href="notifications.html"><i data-lucide="bell"></i> Notifications</a></li>
        <li><a href="settings.html"><i data-lucide="settings"></i> Account Settings</a></li>
        <li><a href="help.html"><i data-lucide="help-circle"></i> Help & Support</a></li>
        <li id="adminPanelLink" style="display:none;"><a href="admin.html"><i data-lucide="shield"></i> Admin Panel</a></li>
      </ul>
      <div id="offcanvas-auth-links" class="mt-auto"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token") || "";
    
    const profileContent = document.getElementById("profileContent");
    const loading = document.getElementById("loading");
    const profilePicEl = document.getElementById("profilePic");
    const profileNameEl = document.getElementById("profile-name");
    const profileEmailEl = document.getElementById("profile-email");
    const profileUserTypeEl = document.getElementById("profile-userType");
    const profileGenderEl = document.getElementById("profile-gender");
    const profileLocationEl = document.getElementById("profile-location");
    const profileJoinedEl = document.getElementById("profile-joined");
    const profileAboutEl = document.getElementById("profile-about");

    const skillsSection = document.getElementById("skillsOfferingSection");
    const skillsEl = document.getElementById("skillsOfferingList");
    const interestsSection = document.getElementById("interestsSection");
    const interestsEl = document.getElementById("learningInterestsList");
    const certificatesSection = document.getElementById("certificatesSection");
    const certificateList = document.getElementById("certificateList");

    const authSection = document.getElementById("auth-section");
    const offcanvasAuthLinks = document.getElementById("offcanvas-auth-links");
    const adminPanelLink = document.getElementById("adminPanelLink");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const themeIcon = document.getElementById("themeIcon");

    let loggedInUser = null;

    const getAuthHeaders = (json = true) => { 
        const headers = {}; 
        if (json) headers["Content-Type"] = "application/json"; 
        if (token) headers["Authorization"] = `Bearer ${token}`; 
        return headers; 
    };

    function renderSkillList(element, data, defaultMsg) {
      if (!element) return;
      element.innerHTML = "";
      const items = Array.isArray(data) ? data : [];
      if (!items.length) {
        element.innerHTML = `<span class="text-muted empty-message">${defaultMsg}</span>`;
        return;
      }
      items.forEach(s => {
        const name = (typeof s === "object" && s.name) ? s.name : (typeof s === 'string' ? s : null);
        if (!name || !name.trim()) return;
        const itemDiv = document.createElement("div");
        itemDiv.className = "skill-list-item";
        itemDiv.innerHTML = `<span>${name.trim()}</span>`;
        element.appendChild(itemDiv);
      });
    }
    
    function renderCertificates(certificates) {
      if (!certificateList) return;
      certificateList.innerHTML = "";
      const certs = Array.isArray(certificates) ? certificates : [];

      if (!certs.length) {
        certificateList.innerHTML = `<span class="text-muted empty-message p-3 text-center">No certificates uploaded.</span>`;
        return;
      }

      certs.forEach(cert => {
        const isPdf = cert.filePath.toLowerCase().endsWith('.pdf');
        const icon = isPdf ? 'file-text' : 'image';
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <a href="${cert.filePath}" target="_blank" rel="noopener noreferrer" class="cert-link d-flex align-items-center">
            <i data-lucide="${icon}" class="cert-icon"></i>
            <span>${cert.name}</span>
          </a>
          <span class="text-muted small">${new Date(cert.uploadedAt).toLocaleDateString()}</span>
        `;
        certificateList.appendChild(li);
      });
      lucide.createIcons();
    }

    function populateUI(user) {
      if (!user) return;
      
      profilePicEl.src = (user.profilePic && typeof user.profilePic === 'string') 
                         ? user.profilePic 
                         : "/uploads/profile-pics/default.png";
      
      profileNameEl.textContent = user.name || "—";
      profileEmailEl.textContent = user.email || "—";
      
      const userType = user.userType || "study";
      profileUserTypeEl.textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
      profileUserTypeEl.className = `badge rounded-pill px-3 py-1 bg-${userType === 'teach' ? 'success' : (userType === 'both' ? 'info' : 'secondary')}-subtle text-${userType === 'teach' ? 'success' : (userType === 'both' ? 'info' : 'secondary')}-emphasis`;
      
      profileGenderEl.textContent = user.gender ? (user.gender.charAt(0).toUpperCase() + user.gender.slice(1)) : "Not specified";
      profileLocationEl.textContent = user.location || "Not specified";
      profileJoinedEl.textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : "—";
      profileAboutEl.textContent = user.about || "No description added yet.";
      
      // Hide/Show sections based on userType
      if (user.userType === 'study') {
        skillsSection.style.display = 'none';
        certificatesSection.style.display = 'none';
      } else {
        skillsSection.style.display = 'block';
        certificatesSection.style.display = 'block';
        renderSkillList(skillsEl, user.skills, "No skills listed yet.");
        renderCertificates(user.certificates || []);
      }
      
      if (user.userType === 'teach') {
        interestsSection.style.display = 'none';
      } else {
        interestsSection.style.display = 'block';
        renderSkillList(interestsEl, user.learningInterests, "No interests listed yet.");
      }

      // Show content
      loading.classList.add('d-none');
      profileContent.classList.remove('d-none');
    }

    async function fetchTutorProfile(userId) {
      try {
        const res = await fetch(`/api/users/${userId}`, { headers: getAuthHeaders(false) });
        if (!res.ok) {
          throw new Error("Could not find this user.");
        }
        const user = await res.json();
        populateUI(user);
      } catch (err) {
        loading.innerHTML = `<p class="text-danger">${err.message}</p>`;
      }
    }

    function setupAuthUI(user) {
        const isLoggedIn = !!token;
        const loginLink = 'login.html';
        const signupLink = 'signup.html';
        if(authSection && offcanvasAuthLinks) {
            if (isLoggedIn && user) {
                authSection.innerHTML = `<button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i data-lucide="log-out" class="me-1" style="width:16px; height:16px;"></i>Logout</button>`;
                offcanvasAuthLinks.innerHTML = `<button id="offcanvasLogoutBtn" class="btn btn-outline-danger w-100"><i data-lucide="log-out" class="me-1"></i>Logout</button>`;
                const logout = () => { localStorage.clear(); window.location.href = loginLink; };
                document.addEventListener('click', function(event) { if (event.target && event.target.id === 'logoutBtn') logout(); if (event.target && event.target.id === 'offcanvasLogoutBtn') logout(); });
                if (user.role === 'admin' && adminPanelLink) adminPanelLink.style.display = 'block';
            } else {
                authSection.innerHTML = `<a href="${loginLink}" class="btn btn-outline-primary btn-sm me-2"><i data-lucide="log-in" class="me-1" style="width:16px; height:16px;"></i>Login</a><a href="${signupLink}" class="btn btn-primary btn-sm"><i data-lucide="user-plus" class="me-1" style="width:16px; height:16px;"></i>Sign Up</a>`;
                offcanvasAuthLinks.innerHTML = `<a href="${loginLink}" class="btn btn-outline-primary w-100 mb-2">Login</a><a href="${signupLink}" class="btn btn-primary w-100">Sign Up</a>`;
            }
        }
        try { lucide.createIcons(); } catch(e) {}
    }
    
    // --- Theme & Particles ---
    const loadParticles = () => { if (typeof tsParticles === 'undefined') return; try { if (window.tsParticles?.dom?.length) window.tsParticles.dom.forEach(d => d.destroy()); const color = getComputedStyle(document.body).getPropertyValue('--bs-primary').trim() || "#0d6efd"; tsParticles.load("tsparticles", { fpsLimit: 60, particles: { number: { value: 40 }, color: { value: color }, opacity: { value: { min: 0.1, max: 0.3 } }, size: { value: { min: 8, max: 18 } }, move: { enable: true, speed: 1.0 } } }); } catch (e) { console.error("tsParticles error", e); } };
    function setTheme(theme) { const isDark = theme === "dark"; document.body.setAttribute("data-bs-theme", theme); if (themeIcon) themeIcon.setAttribute("data-lucide", isDark ? "sun" : "moon"); try { lucide.createIcons(); } catch (e) { console.warn("Lucide error:", e); } localStorage.setItem("theme", theme); setTimeout(loadParticles, 50); }
    try { const savedTheme = localStorage.getItem("theme"); const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches; setTheme(savedTheme ? savedTheme : (prefersDark ? "dark" : "light")); if (darkModeToggle) { darkModeToggle.addEventListener("click", () => { const newTheme = document.body.getAttribute("data-bs-theme") === "dark" ? "light" : "dark"; setTheme(newTheme); }); } } catch (err) { console.error("Theme init error", err); }
    // --- End Theme ---

    // --- Main ---
    function main() {
      try {
        loggedInUser = JSON.parse(localStorage.getItem("user") || "null");
      } catch (e) {
        console.error("Could not parse logged in user");
      }
      setupAuthUI(loggedInUser);

      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id');

      if (!userId) {
        loading.innerHTML = `<p class="text-danger">No user ID provided.</p>`;
        return;
      }
      
      fetchTutorProfile(userId);
    }
    
    main();

  });
  </script>
</body>
</html>