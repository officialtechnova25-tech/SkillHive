<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Skill Hive</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>

  <style>
    :root {
      --avatar-size: 40px;
    }
    
    html, body {
        height: 100%;
    }
    body {
      font-family: "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      transition: background-color 0.4s ease, color 0.4s ease;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
        flex: 1 0 auto;
    }
    footer {
        flex-shrink: 0;
    }
    
    .avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius:50%; object-fit:cover; }
    
    .animated-card { 
      /* === UPDATED: Smoother transition === */
      transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, background-color 0.4s ease, border-color 0.4s ease;
    }
    .animated-card:hover { 
      /* === UPDATED: More noticeable hover === */
      transform: translateY(-6px); 
      box-shadow: 0 12px 24px rgba(0,0,0,0.1); 
    }
    [data-bs-theme="dark"] .animated-card:hover {
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    
    .tutor-suggestion-link {
        display: block;
        text-decoration: none;
        color: inherit;
        transition: background-color 0.2s ease, transform 0.2s ease; /* Added transform */
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        padding: 0.75rem;
    }
    .tutor-suggestion-link:hover {
        background-color: rgba(var(--bs-primary-rgb, 13,110,253), 0.06);
        color: inherit;
        transform: translateX(4px); /* Added slight move on hover */
    }
    .tutor-suggestion-link .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    @media (max-width: 768px) {
      .navbar-brand img { width: 90px; height: 60px; }
      .avatar { width: 36px; height: 36px; }
    }

    /* Glass Header Styles */
    .header-glass {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: background 0.4s ease, border-color 0.4s ease;
    }
    [data-bs-theme="dark"] .header-glass {
      background: rgba(33, 37, 41, 0.25);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Sliding Animation */
    @keyframes fadeInUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* === NEW: Animation class for the heading === */
    .animate-heading {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out 0.1s forwards; /* Shortest delay */
    }
    .animate-col-1 {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out 0.2s forwards;
    }
    .animate-col-2 {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out 0.4s forwards;
    }
  </style>
</head>

<body data-bs-theme="light" class="dashboard-page">
  <div id="tsparticles" style="position:fixed; inset:0; z-index:-1;"></div>

  <header class="sticky-top header-glass">
    <script src="config.js"></script>

    <div class="container d-flex justify-content-between align-items-center py-2">
      <div class="flex-grow-1">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvas" aria-controls="mainOffcanvas">
          <i data-lucide="menu"></i>
        </button>
      </div>

      <div class="flex-grow-1 text-center">
        <a class="navbar-brand d-inline-flex align-items-center" href="index.html">
          <img src="assets/images/skillhive-logo.png" alt="Skill Hive Logo" width="110" height="70" loading="lazy"/>
          <span class="ms-2">Skill Hive</span>
        </a>
      </div>

      <div class="flex-grow-1 d-flex justify-content-end align-items-center gap-2">
        <button id="darkModeToggle" class="btn btn-outline-secondary" title="Toggle dark mode">
          <i id="themeIcon" data-lucide="moon"></i>
        </button>
        <button id="logoutBtnTop" class="btn btn-outline-danger">
          <i data-lucide="log-out"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <main class="container my-5">
    <h1 class="text-center mb-4 animate-heading">
      My Dashboard â€” <span id="userName" class="text-primary"></span>
    </h1>
    <div class="row g-4">
      <div class="col-md-7 animate-col-1">
        <div class="card p-3 mb-4 animated-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 id="user-level">Level 1</h4>
            <span class="badge bg-warning">Newcomer</span>
          </div>
          <div class="progress" style="height: 25px;">
            <div id="xp-progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 10%;">10 / 500 XP</div>
          </div>
        </div>

        <div id="teachingSection" class="card p-3 mb-4 animated-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>My Skills (Teaching)</h4>
          </div>
          <ul id="skillsList" class="list-group list-group-flush"></ul>
          <div id="noSkillsMessage" class="text-center mt-3 text-muted" style="display:none;">
            You havenâ€™t added any teaching skills yet.
            <div class="mt-2">
              <a href="profile.html" class="btn btn-outline-primary btn-sm">Go to Profile to Add Skills</a>
            </div>
          </div>
        </div>

        <div class="card p-3 mb-4 animated-card">
          <h4>My Achievements</h4>
          <ul id="achievementsList" class="list-group list-group-flush">
             <li class="list-group-item text-muted">No achievements yet.</li>
           </ul>
        </div>
      </div>

      <div class="col-md-5 animate-col-2">
        <div class="card p-3 animated-card">
          <h4>Suggested Tutors</h4>
          <div id="suggestionsList">
             <p class="text-muted">Loading suggestions...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4">
    <div class="container text-center">
      <p class="mb-0 text-muted">&copy; 2025 Skill Hive â€” Powered by Tech Nova</p>
    </div>
  </footer>

   <div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mainOffcanvasLabel">Skill Hive Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <ul class="list-unstyled nav-links">
        <li class="text-muted small mb-2 text-start">MAIN MENU</li>
        <li><a href="index.html"><i data-lucide="home"></i> Home</a></li>
        <li><a href="dashboard.html" class="active"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
        <li><a href="profile.html"><i data-lucide="user"></i> My Profile</a></li>
        <li><a href="search.html"><i data-lucide="search"></i> Find Skills</a></li>
      </ul>
      <hr />
      <ul class="list-unstyled nav-links">
         <li class="text-muted small mb-2 text-start">SETTINGS</li>
         <li><a href="notifications.html"><i data-lucide="bell"></i> Notifications</a></li>
         <li><a href="settings.html"><i data-lucide="settings"></i> Account Settings</a></li>
         <li><a href="help.html"><i data-lucide="help-circle"></i> Help & Support</a></li>
         <li id="adminPanelLink" style="display:none;"><a href="admin.html"><i data-lucide="shield"></i> Admin Panel</a></li>
       </ul>
      <div id="offcanvas-auth-links" class="mt-auto">
        <button id="logoutBtnCanvas" class="btn btn-outline-danger w-100"><i data-lucide="log-out"></i> Logout</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
  // lucide icons - guard in case library not loaded yet
  try { lucide.createIcons(); } catch (e) { console.warn("lucide.createIcons() failed:", e); }

  const API_BASE = "/api";
  const getAuthHeaders = () => {
    const token = localStorage.getItem("token");
    const headers = { "Content-Type": "application/json" };
    if (token) headers["Authorization"] = `Bearer ${token}`;
    return headers;
  };

  // ---------- LOGIN CHECK ----------
  const token = localStorage.getItem("token");
  let userFromStorage = {}; // Renamed to clarify it's from storage
  try {
     const userString = localStorage.getItem("user");
     userFromStorage = userString ? JSON.parse(userString) : {};
  } catch (e) {
     console.error("Error parsing user data from localStorage:", e);
     localStorage.removeItem("user"); // Clear invalid data
     userFromStorage = {};
  }

  // Use the ID from storage (check for _id from MongoDB or id)
  const userId = userFromStorage._id || userFromStorage.id;

  if (!token || !userId) {
    console.log("Redirecting to login: No token or user ID found.");
    window.location.href = "login.html";
    return; // Stop script execution
  }
  
  // ---------- THEME (Can run immediately) ----------
  const darkModeToggle = document.getElementById("darkModeToggle");
  const themeIcon = document.getElementById("themeIcon");
  const body = document.body;
  
  function loadParticles() {
    if (typeof tsParticles === 'undefined') {
        console.warn("tsParticles not loaded.");
        return;
    }
    try {
        // destroy any existing instances
        if (window.tsParticles?.dom?.length) window.tsParticles.dom.forEach(d=>d.destroy());
        // pick a color similar to body text color (fallback)
        const computed = getComputedStyle(body).getPropertyValue("--bs-body-color");
        const color = computed ? computed.trim() : "#333";
        tsParticles.load("tsparticles", {
          fpsLimit: 60,
          particles: {
            number: { value: 60 },
            color: { value: color },
            opacity: { value: { min: 0.2, max: 0.5 } },
            size: { value: { min: 12, max: 22 } },
            move: { enable: true, speed: 1.5 }
          }
        });
    } catch(e) { console.error("tsParticles load error:", e); }
  }

  function setTheme(theme) {
    const isDark = theme === "dark";
    body.setAttribute("data-bs-theme", theme);
    try { themeIcon.setAttribute("data-lucide", isDark ? "sun" : "moon"); } catch(e){}
    try { lucide.createIcons(); } catch(e){ }
    localStorage.setItem("theme", theme);
    loadParticles();
  }

  const savedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
  setTheme(savedTheme);
  darkModeToggle.addEventListener("click", () => {
    setTheme(body.getAttribute("data-bs-theme") === "dark" ? "light" : "dark");
  });

  // ---------- LOGOUT (Can run immediately) ----------
  const logoutBtns = [document.getElementById("logoutBtnTop"), document.getElementById("logoutBtnCanvas")];
  logoutBtns.forEach(btn => btn?.addEventListener("click", () => {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    localStorage.removeItem("theme"); // Also clear theme preference
    window.location.href = "login.html";
  }));

  // ---------- PAGE CONTENT ELEMENTS ----------
  const teachingSection = document.getElementById("teachingSection");
  const skillsList = document.getElementById("skillsList");
  const noSkillsMessage = document.getElementById("noSkillsMessage");
  const suggestionsList = document.getElementById("suggestionsList");

  // ---------- HELPER FUNCTIONS ----------
  function renderSkills(skillsArr) {
    skillsList.innerHTML = "";
    const skillsToRender = Array.isArray(skillsArr) ? skillsArr : [];
    noSkillsMessage.style.display = skillsToRender.length === 0 ? "block" : "none";

    skillsToRender.forEach(skill => {
      const skillName = (typeof skill === 'object' && skill.name) ? skill.name : (typeof skill === 'string' ? skill : "Unnamed Skill");
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `<div><strong>${escapeHtml(skillName)}</strong></div>
        <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">Skill</span>`;
      skillsList.appendChild(li);
    });
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return "";
    return String(str)
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#39;");
  }

  // ---------- Function to get fresh user data ----------
  async function fetchCurrentUser(id) {
    try {
        const res = await fetch(`${API_BASE}/auth/me`, {
            headers: getAuthHeaders()
        });
        
        if (!res.ok) {
            if (res.status === 401 || res.status === 403) {
                console.warn("Auth token invalid or expired. Logging out.");
                localStorage.clear(); // Use clear() on auth failure
                window.location.href = "login.html";
            }
            throw new Error(`Failed to fetch user data: ${res.statusText}`);
        }
        const freshUser = await res.json();
        
        // **IMPORTANT**: Update localStorage with the fresh data
        localStorage.setItem("user", JSON.stringify(freshUser));
        console.log("Fetched and updated fresh user data:", freshUser);
        return freshUser;
    } catch (err) {
        console.error("Error fetching current user:", err.message);
        return null; // Fallback to stale data if fetch fails
    }
  }
  
  // ---------- Function to fetch suggestions ----------
  async function fetchSuggestions(currentUser) {
    suggestionsList.innerHTML = `<p class="text-muted">Loading suggestions...</p>`;
    const prevSmall = suggestionsList.previousElementSibling;
    if (prevSmall && prevSmall.tagName === 'SMALL') prevSmall.remove();

    try {
      const interestsArray = Array.isArray(currentUser.learningInterests) ? currentUser.learningInterests : [];
      const interestsNames = interestsArray.map(s => (typeof s === 'object' && s.name) ? s.name : (typeof s === 'string' ? s : '')).filter(Boolean);
      
      if (interestsNames.length === 0) {
        suggestionsList.innerHTML = `<p class="text-muted">Add some "Interests" to your profile to get tutor suggestions.</p>`;
        return;
      }
      
      const url = `${API_BASE}/users/suggested`; // Use the dedicated "suggested" route
      console.log("Fetching tutor suggestions from:", url);

      const res = await fetch(url, { headers: getAuthHeaders() });

      if (!res.ok) {
         let errorData = { message: `HTTP error! Status: ${res.status} ${res.statusText}` };
         try {
             const jsonData = await res.json();
             errorData = jsonData || errorData;
         } catch (parseError) {
             console.warn("Could not parse error response as JSON:", parseError);
         }
         throw new Error(errorData.message || `Failed to fetch tutors`);
      }
      
      const data = await res.json();
      const tutors = data.tutors; // The backend now returns { tutors: [...] }
      console.log("Received tutors:", tutors);

      const filtered = Array.isArray(tutors) ? tutors : [];

      if (!filtered.length) {
        suggestionsList.innerHTML = `<p class="text-muted">No relevant tutors found matching your interests.</p>`;
        if (interestsNames.length > 0) {
            suggestionsList.insertAdjacentHTML('beforebegin', `<small class="d-block text-muted mb-2">Based on your interests:</small>`);
        }
        return;
      }

      suggestionsList.innerHTML = ""; // Clear loading message

      if (interestsNames.length > 0) {
          suggestionsList.insertAdjacentHTML('beforebegin', `<small class="d-block text-muted mb-2">Tutors matching your interests:</small>`);
      }
      
      filtered.slice(0, 6).forEach(u => {
        const tutorName = u.name || u.email || 'Unnamed Tutor';

        // ==================================
        // === THIS IS THE CORRECTED LINE ===
        // ==================================
        const avatarUrl = (u.profilePic && typeof u.profilePic === 'string') 
                          ? u.profilePic 
                          : "/uploads/profile-pics/default.png";
        
        const skillText = Array.isArray(u.skills) ? u.skills.map(s => (typeof s === 'object' && s.name) ? s.name : (typeof s === 'string' ? s : '')).filter(Boolean).join(", ") : "No skills listed";
        
        const link = document.createElement("a");
        link.href = `search.html?query=${encodeURIComponent(tutorName)}`;
        link.className = "tutor-suggestion-link";
        link.setAttribute("aria-label", `View tutor ${tutorName}`);

        link.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="${escapeHtml(avatarUrl)}" class="avatar me-2" alt="${escapeHtml(tutorName)}" loading="lazy" onerror="this.onerror=null;this.src='/uploads/profile-pics/default.png'"/>
            <div class="flex-grow-1 min-w-0">
              <strong>${escapeHtml(tutorName)}</strong><br />
              <small class="text-muted text-truncate d-block">Teaches: ${escapeHtml(skillText)}</small>
            </div>
          </div>`;
          
        suggestionsList.appendChild(link);
      });
    } catch (err) {
      console.error("Error loading tutor suggestions:", err);
      suggestionsList.innerHTML = `<p class="text-danger small">Unable to load tutors.</p><p class="text-danger small">${escapeHtml(err.message || 'Unknown error')}</p>`;
    }
  }
  
  // ---------- Main function to run the dashboard logic ----------
  async function initializeDashboard() {
     const freshUser = await fetchCurrentUser(userId);
     const user = freshUser || userFromStorage;

     console.log("Populating dashboard using user:", user);
     document.getElementById("userName").textContent = user.name || user.email || "User";

     if (user.userType === "study") {
       teachingSection.style.display = "none";
     }
     
     renderSkills(user.skills || []);
     fetchSuggestions(user);
  }

  // --- Run the main logic ---
  initializeDashboard();

});
  </script>
</body>
</html>
