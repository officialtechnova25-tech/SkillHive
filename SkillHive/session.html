<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skill Hive - Live Session</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://8x8.vc/external_api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
  
  <link href="css/styles.css" rel="stylesheet" /> 
  <style>
    /* your full CSS exactly as in your version */

    /* === CHANGED: Added new styles for chat, participants, and loader === */
    .glass-header .btn-danger {
        --bs-btn-bg: var(--bs-danger-bg-subtle);
        --bs-btn-border-color: var(--bs-danger-bg-subtle);
        --bs-btn-color: var(--bs-danger-text-emphasis);
        --bs-btn-hover-bg: var(--bs-danger);
        --bs-btn-hover-border-color: var(--bs-danger);
        --bs-btn-hover-color: #fff;
    }

    /* New Chat Message Styles */
    .chat-box {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-message {
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 85%;
      opacity: 0;
      animation: messageFadeIn 0.3s ease forwards;
    }
    .chat-message.remote {
      background-color: var(--bs-secondary-bg-subtle);
      border-bottom-left-radius: 2px;
      align-self: flex-start;
      text-align: left;
    }
    .chat-message.local {
      background-color: var(--bs-primary-bg-subtle);
      color: var(--bs-primary-text-emphasis);
      border-bottom-right-radius: 2px;
      align-self: flex-end;
      text-align: left; /* Keep text left-aligned inside bubble */
    }
    .chat-message.system {
      background-color: transparent;
      color: var(--bs-secondary-color);
      font-style: italic;
      font-size: 0.85rem;
      text-align: center;
      align-self: center;
      padding: 2px;
    }
    .chat-message strong {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--bs-primary);
    }
    .chat-message.local strong {
      color: var(--bs-primary-text-emphasis);
    }
    .chat-message .timestamp {
      font-size: 0.75rem;
      color: var(--bs-secondary-color);
      display: block;
      margin-top: 4px;
      text-align: right;
    }

    @keyframes messageFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* New Loader/Error Styles */
    #jitsi-state-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 10;
      gap: 1rem;
    }
    #jitsi-state-overlay .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    /* Participant List Styles */
    #participantsList {
      list-style: none;
      padding-left: 0;
    }
    #participantsList li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 8px 4px;
      font-weight: 500;
      border-bottom: 1px solid var(--bs-border-color-translucent);
    }
    #participantsList li:last-child {
      border-bottom: none;
    }
    #participantsList li i {
      color: var(--bs-primary);
    }
    /* === END CHANGED === */
  </style>
</head>
<body>

  <div id="tsparticles"></div>

  <header class="glass-header sticky-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      
      <div class="d-flex align-items-center" style="flex: 1;">
        <button class="btn btn-primary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvas">
          <i data-lucide="menu"></i>
        </button>
      </div>
  
      <a class="navbar-brand d-flex align-items: center text-primary fw-bold mx-auto" href="index.html" style="flex: 1; justify-content: center;">
        <img src="assets/images/skillhive-logo.png" alt="Skill Hive Logo" class="brand-logo me-2">
        <span>Skill Hive</span>
      </a>
  
      <div class="d-flex align-items-center" style="flex: 1; justify-content: flex-end; gap: 0.5rem;">
        <button id="leaveSessionBtn" class="btn btn-danger btn-sm" title="Leave Session" style="display: none;">
          <i data-lucide="log-out" class="me-1" style="width:16px; height:16px;"></i>
          Leave
        </button>
        <button id="darkModeToggle" class="btn btn-outline-secondary">
          <i id="themeIcon" data-lucide="moon"></i>
        </button>
      </div>

    </div>
  </header>
  <main class="container-fluid subtle-fade-in">
    <div class="row g-4 main-row">
      <div class="col-lg-8 main-col">
         <div id="jitsi-wrapper" class="glass-effect">
            <div id="jitsi-container">
                <div id="jitsi-state-overlay">
                  <div id="jitsi-loader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <h5 class="mt-3 mb-0">Connecting to session...</h5>
                    <span class="text-muted">Please wait.</span>
                  </div>
                  <div id="jitsi-error" class="alert alert-danger m-3" style="display: none;">
                    <strong>Error:</strong> <span id="jitsi-error-message"></span>
                  </div>
                </div>
                </div>
         </div>
      </div>

      <div class="col-lg-4 main-col">
        <div class="card glass-effect chat-card">
          <div class="card-header p-0">
            <ul class="nav nav-tabs nav-fill" id="chatTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane" type="button" role="tab">
                  <i data-lucide="messages-square" class="me-1" style="width:16px;"></i>
                  Chat
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants-tab-pane" type="button" role="tab">
                  <i data-lucide="users" class="me-1" style="width:16px;"></i>
                  Participants (<span id="participant-count">0</span>)
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body tab-content" style="padding-bottom: 0.75rem;">
            <div class="tab-pane fade show active" id="chat-tab-pane" role="tabpanel">
              <div id="chatBox" class="chat-box">
                </div>
            </div>
            <div class="tab-pane fade" id="participants-tab-pane" role="tabpanel">
              <div class="chat-box"> <ul id="participantsList">
                  </ul>
              </div>
            </div>
          </div>
          <div class="card-footer bg-transparent border-0 pt-0">
            <div class="input-group chat-input-group">
              <input type="text" id="chatInput" class="form-control" placeholder="Type a message...">
              <button class="btn btn-primary" id="sendBtn" type="button">
                <i data-lucide="send" style="width: 18px; height: 18px;"></i>
              </button>
            </div>
          </div>
        </div>
        </div>
    </div>
  </main>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Skill Hive Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <ul class="nav flex-column nav-links">
        <li class="nav-item"><a href="dashboard.html" class="nav-link"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
        <li class="nav-item"><a href="profile.html" class="nav-link"><i data-lucide="user"></i> My Profile</a></li>
        <li class="nav-item"><a href="search.html" class="nav-link"><i data-lucide="search"></i> Find Skills</a></li>
        <li class="nav-item" id="adminPanelLinkOffcanvas" style="display:none;"><a href="admin.html" class="nav-link"><i data-lucide="shield"></i> Admin Panel</a></li>
      </ul>
      <div class="logout-area">
         <a href="#" id="logoutBtnCanvas" class="nav-link text-danger logout-link"><i data-lucide="log-out"></i> Logout</a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Theme Persistence ---
    (function() {
      const themeIcon = document.getElementById('themeIcon');
      const savedTheme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
      if (themeIcon) themeIcon.setAttribute('data-lucide', savedTheme === 'dark' ? 'sun' : 'moon');
    })();

    if (typeof lucide !== 'undefined') lucide.createIcons();

    document.addEventListener("DOMContentLoaded", () => {
      const chatBox = document.getElementById("chatBox");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const jitsiContainer = document.getElementById("jitsi-container");
      const darkToggle = document.getElementById("darkModeToggle");
      const themeIcon = document.getElementById("themeIcon");
      const rootHtmlElement = document.documentElement;

      // === CHANGED: New Element Selectors ===
      const leaveSessionBtn = document.getElementById("leaveSessionBtn");
      const jitsiLoader = document.getElementById("jitsi-loader");
      const jitsiError = document.getElementById("jitsi-error");
      const jitsiErrorMessage = document.getElementById("jitsi-error-message");
      const participantsList = document.getElementById("participantsList");
      const participantCount = document.getElementById("participant-count");
      // === END CHANGED ===

      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "null");
      if (!token || !user) return (window.location.href = "login.html");

      const adminLinkOffcanvas = document.getElementById('adminPanelLinkOffcanvas');
      if (adminLinkOffcanvas && user?.role === 'admin') adminLinkOffcanvas.style.display = 'block';

      document.getElementById('logoutBtnCanvas').addEventListener('click', e => {
        e.preventDefault(); localStorage.clear(); window.location.href = "index.html";
      });

      let api = null;
      let myUserId = null;
      // === CHANGED: Map to store participant info ===
      let participants = new Map();
      // === END CHANGED ===

      // === CHANGED: Helper to show loading/error states ===
      function setJitsiState(state, message = "") {
        if (state === 'loading') {
          jitsiLoader.style.display = 'block';
          jitsiError.style.display = 'none';
        } else if (state === 'error') {
          jitsiLoader.style.display = 'none';
          jitsiErrorMessage.textContent = message;
          jitsiError.style.display = 'block';
        } else if (state === 'loaded') {
          jitsiLoader.style.display = 'none';
          jitsiError.style.display = 'none';
          // The Jitsi iframe will cover the overlay
        }
      }
      // === END CHANGED ===

      async function loadSession() {
        try {
          setJitsiState('loading'); // Show loader
          const urlParams = new URLSearchParams(window.location.search);
          const sessionId = urlParams.get('session');
          if (!sessionId) throw new Error("No session ID in URL.");

          const res = await fetch(`/api/sessions/${sessionId}`, { headers: { 'Authorization': `Bearer ${token}` } });
          const session = await res.json();
          if (!session.roomName) throw new Error("Session invalid or not confirmed.");

          const tokenRes = await fetch("/api/meet/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user, room: session.roomName })
          });
          if (!tokenRes.ok) throw new Error("Could not get session token.");
          const { token: meetToken } = await tokenRes.json();
          if (!meetToken) throw new Error("Received invalid session token.");

          // === CHANGED: Clear container *before* init ===
          // We don't clear innerHTML anymore because the overlay is inside
          // jitsiContainer.innerHTML = ''; 
          // === END CHANGED ===

          const domain = "8x8.vc";
          const options = {
            roomName: session.roomName,
            jwt: meetToken,
            parentNode: jitsiContainer,
            width: "100%",
            height: "100%",
            userInfo: {
              email: user?.email || undefined,
              displayName: user?.name || 'Guest'
            },
            interfaceConfigOverwrite: {
              TOOLBAR_BUTTONS: ['microphone','camera','desktop','chat','raisehand','tileview','fullscreen','hangup','settings','fodeviceselection'],
              SHOW_JITSI_WATERMARK: false,
              SHOW_BRAND_WATERMARK: false,
              SHOW_POWERED_BY: false
            },
            configOverwrite: {
              prejoinPageEnabled: false,
              startWithAudioMuted: false,
              startWithVideoMuted: false
            }
          };

          api = new JitsiMeetExternalAPI(domain, options);
          console.log("✅ Jitsi (JaaS) loaded:", session.roomName);
          attachJitsiListeners();

          // Hide loader once the iframe is loaded
          api.addEventListener('videoConferenceJoined', () => {
            setJitsiState('loaded');
            leaveSessionBtn.style.display = 'block';
          });

        } catch (err) {
          console.error("Jitsi init error:", err);
          // === CHANGED: Use new error state ===
          setJitsiState('error', err.message);
          // === END CHANGED ===
        }
      }

      function attachJitsiListeners() {
        if (!api) return;
        
        // Store my own ID and add to participant list
        api.addEventListener('videoConferenceJoined', e => {
          myUserId = e.id;
          participants.set(e.id, { id: e.id, name: e.displayName, isMe: true });
          updateParticipantList();
          addSystemMessage('You joined the session.');
        });
        
        // Handle incoming chat
        api.addEventListener('incomingMessage', e => {
          if (myUserId && e.from !== myUserId) {
            addMessage(e.nick || 'Guest', e.message, false);
          }
        });

        // Handle my own chat
        api.addEventListener('outgoingMessage', e => {
          addMessage(api.getDisplayName() || 'You', e.message, true);
        });

        // === CHANGED: New Participant Listeners ===
        api.addEventListener('participantJoined', e => {
          participants.set(e.id, { id: e.id, name: e.displayName, isMe: false });
          updateParticipantList();
          addSystemMessage(`${e.displayName} joined.`);
        });

        api.addEventListener('participantLeft', e => {
          const p = participants.get(e.id);
          if (p) {
            participants.delete(e.id);
            updateParticipantList();
            addSystemMessage(`${p.name} left.`);
          }
        });

        api.addEventListener('displayNameChange', e => {
          const p = participants.get(e.id);
          if (p) {
            p.name = e.displayname;
            updateParticipantList();
          }
        });
        // === END CHANGED ===

        // Handle window close
        window.addEventListener('beforeunload', () => api && api.dispose());
      }
      
      // === CHANGED: New function to update participant list UI ===
      function updateParticipantList() {
        if (!participantsList || !participantCount) return;
        
        participantsList.innerHTML = ''; // Clear list
        
        // Sort participants, putting "You" first
        const sortedParticipants = [...participants.values()].sort((a, b) => {
          if (a.isMe) return -1;
          if (b.isMe) return 1;
          return a.name.localeCompare(b.name);
        });

        sortedParticipants.forEach(p => {
          const li = document.createElement('li');
          const icon = p.isMe ? 'user-check' : 'user';
          li.innerHTML = `<i data-lucide="${icon}" style="width:18px;"></i> ${p.name}`;
          participantsList.appendChild(li);
        });

        participantCount.textContent = participants.size;
        try { lucide.createIcons(); } catch(e) {}
      }
      // === END CHANGED ===

      // === CHANGED: Overhauled addMessage function ===
      function addMessage(sender, text, isLocal = false) {
        const div = document.createElement("div");
        div.classList.add("chat-message", isLocal ? "local" : "remote");
        
        const time = new Date().toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit'
        });

        const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        div.innerHTML = `<strong>${sender}</strong>
                         <div>${sanitizedText}</div>
                         <span class="timestamp">${time}</span>`;
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      
      // New function for system messages (join/leave)
      function addSystemMessage(text) {
        const div = document.createElement("div");
        div.classList.add("chat-message", "system");
        div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      // === END CHANGED ===


      function sendMessage() {
        const msg = chatInput.value.trim();
        if (msg && api) { 
          api.executeCommand('sendChatMessage', msg); 
          chatInput.value = ""; 
        }
      }
      sendBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

      darkToggle.addEventListener("click", () => {
        const currentTheme = rootHtmlElement.getAttribute("data-bs-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      });

      function setTheme(theme) {
        const isDark = theme === "dark";
        rootHtmlElement.setAttribute("data-bs-theme", theme);
        themeIcon.setAttribute("data-lucide", isDark ? "sun" : "moon");
        localStorage.setItem("theme", theme);
        lucide.createIcons();
      }

      // === CHANGED: Event listener for new Leave button ===
      leaveSessionBtn.addEventListener('click', () => {
        if (api) {
          api.dispose();
        }
        // Redirect to dashboard after leaving
        window.location.href = 'dashboard.html'; 
      });
      // === END CHANGED ===

      loadSession();
    });
  </script>

</body>
</html>